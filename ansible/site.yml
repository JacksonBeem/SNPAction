---
- name: Deploy static site to S3 and invalidate CloudFront
  hosts: localhost
  vars:
    s3_bucket: "{{ lookup('env','S3_BUCKET') }}"
    cloudfront_id: "{{ lookup('env','CLOUDFRONT_ID') }}"
    api_url: "{{ lookup('env','API_URL') }}"
  tasks:
    - name: Create config.json with API endpoint
      copy:
        dest: "{{ playbook_dir }}/../frontend/config.json"
        content: |
          { "api_url": "{{ api_url }}" }

    - name: Sync frontend/ to S3 bucket
      community.aws.s3_sync:
        bucket: "{{ s3_bucket }}"
        file_root: "{{ playbook_dir }}/../frontend/"
        key_prefix: ""
        include: "*"
        delete: false
        file_change_strategy: checksum
        cache_control: "public, max-age=300"

    - name: Invalidate CloudFront cache
      community.aws.cloudfront_invalidation:
        distribution_id: "{{ cloudfront_id }}"
        target_paths:
          - "/*"
